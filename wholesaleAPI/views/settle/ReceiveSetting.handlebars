{{!-- 数据格 --}}

<div class="easyui-layout" style="width:100%;height:100%;">
    <div data-options="region:'north',split:true" title="货单" style="width:400px;height:350px;">
        <table id="receive-dg" class="easyui-datagrid" style="width:100%;height:400px;border-top:0px;" toolbar="#receive-tbr" data-options="singleSelect:true,collapsible:true,method:'get',fit:true,border:false">
            <thead>
                <tr>
                    <th data-options="field:'LoadId',width:150">装运单</th>
                    <th data-options="field:'ReceiveId',width:150">缴款单</th>
                    <th data-options="field:'warehouseId',width:80">仓库</th>
                    <th data-options="field:'PlanDeliveryManId',width:80">计划送货人</th>
                    <th data-options="field:'RealDeliveryManId',width:80">实际送货人</th>
                    <th data-options="field:'UpdateUser',width:120">更新人</th>
                    <th data-options="field:'UpdateDate',width:120">更新时间</th>
                    <th data-options="field:'CheckOutDate',width:120">出仓时间</th>
                    <th data-options="field:'Confirm',width:120">打印确认</th>
                    <th data-options="field:'CheckOutStatus',width:120">出库状态</th>
                    <th data-options="field:'BalanceStatus',width:120">平衡状态</th>
                </tr>
            </thead>
        </table>
    </div>
    <div data-options="region:'center',split:true" style="height:300px;">
        <table id="receive-detail-dg" class="easyui-datagrid" style="width:100%;height:250px;border-top:0px;" toolbar="#receive-detail-tbr"
            data-options="singleSelect:true,collapsible:true,method:'get',fit:true,border:false," title="货单明细">
            <thead>
                <tr>
                    <th data-options="field:'RealDeliveryManId',width:120">送货人</th>
                    <th data-options="field:'CreateDate',width:250">缴款时间</th>
                    <th data-options="field:'MoneyType',width:100">缴款类型</th>
                    <th data-options="field:'Amount',width:100">缴款金额</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
{{!-- 工具栏 --}}
<div id="receive-tbr">
    <input id="receive-cg-warehouseId" class="easyui-combogrid" style="width:150px" data-options="prompt:'选择仓库',required:true,validateOnCreate:false,panelWidth: 200,
                    idField: 'WarehouseId',
                    textField: 'WarehouseName',
                    url: '/warehouse/getWarehouse',
                    method: 'get',
                    columns: [[
                        {field:'WarehouseId',title:'仓库编号',width:100},
                        {field:'WarehouseName',title:'仓库名称',width:120}
                    ]],
                    onChange: function (q){  
                        //Search();
                        //receive false;  
                    },
                    onSelect:function(index,row){
                        //changeLogSearch();
                    }
                ">
    <input id="receive-txt-loadId" style="width:120px;height:25px">
    <input id="receive-txt-receiveId" style="width:120px;height:25px">
    <input id="receive-date-deliverDate" class="easyui-datebox" style="width:130px;">
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="receiveSearch()">查询</a>
</div>

<div id="receive-detail-tbr">
    <input id="receive-detail-cg-staffId" class="easyui-combogrid" style="width:150px" data-options="prompt:'选实际送货人',required:true,validateOnCreate:false,panelWidth: 200,
                    idField: 'ItemValue',
                    textField: 'ItemText',
                    url: '/staff/getStaff',
                    method: 'get',
                    columns: [[
                        {field:'ItemValue',title:'员工编号',width:100},
                        {field:'ItemText',title:'员工名称',width:120}
                    ]],
                    onChange: function (q){  
                        //Search();
                        //return false;  
                    },
                    onSelect:function(index,row){
                        //changeLogSearch();
                    }
                ">
    <input id="receive-detail-cg-moneyType" class="easyui-combogrid" style="width:150px" data-options="prompt:'收款类型',required:true,validateOnCreate:false,panelWidth: 200,
                    idField: 'ItemValue',
                    textField: 'ItemText',
                    url: '/common/moneytype',
                    method: 'get',
                    columns: [[
                        {field:'ItemValue',title:'员工编号',width:100},
                        {field:'ItemText',title:'员工名称',width:120}
                    ]],
                    onChange: function (q){  
                        //Search();
                        //return false;  
                    },
                    onSelect:function(index,row){
                        //changeLogSearch();
                    }
                ">
    <input id="receive-detail-txt-amount" style="width:200px;height:25px" data-options="validType:'number'">
    <span class="datagrid-btn-separator" style="vertical-align: middle;display:inline-block;float:none"></span>
    <a id="#receive-detail-bt-add" onclick="receiveDetailMod();" href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-add">收款</a>
</div>

{{!-- 对话框 --}} {{!-- 脚本 --}}
<script>
    $.extend($.fn.textbox.methods, {
        addClearBtn: function (jq, iconCls) {
            return jq.each(function () {
                var t = $(this);
                var opts = t.textbox('options');
                opts.icons = opts.icons || [];
                opts.icons.unshift({
                    iconCls: iconCls,
                    handler: function (e) {
                        $(e.data.target).textbox('clear').textbox('textbox').focus();
                        $(this).css('visibility', 'hidden');
                    }
                });
                t.textbox();
                if (!t.textbox('getText')) {
                    t.textbox('getIcon', 0).css('visibility', 'hidden');
                }
                t.textbox('textbox').bind('keyup', function () {
                    var icon = t.textbox('getIcon', 0);
                    if ($(this).val()) {
                        icon.css('visibility', 'visible');
                    } else {
                        icon.css('visibility', 'hidden');
                    }
                });
            });
        }
    });


    $(function () {

        //-----
        $('#receive-txt-loadId').textbox({
            prompt: '装运单号',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');

        $('#receive-txt-receiveId').textbox({
            prompt: '缴款单号',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');

        $('#receive-date-deliverDate').datebox({
            prompt: '送货时间时间',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');

        $('#receive-detail-txt-amount').textbox({
            prompt: '缴款金额',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');
        //------

    });

    function receiveAdd() {
        var fromWarehouseId = $('#receive-cg-fromWarehouseId').combogrid('getValue');
        var toWarehouseId = $('#receive-cg-toWarehouseId').combogrid('getValue');
        if (fromWarehouseId == "") {
            $.messager.alert('消息提示:', "<center>请选择发出仓库</center>");
            return;
        }
        if (toWarehouseId == "") {
            $.messager.alert('消息提示:', "<center>请选择接收仓库</center>");
            return;
        }
        $.post("/warehouse/addreceive", { fromWarehouseId: fromWarehouseId, toWarehouseId: toWarehouseId },
            function (data) {
                $.messager.alert('消息提示:', "<center>" + data[0]["pramResult"] + "</center>");
                $('#receive-dg').datagrid('reload');
            }
        );
    }

    function receiveSearch() {
        var warehouseId = $('#receive-cg-warehouseId').val();
        var checkOutDate = $('#receive-date-deliverDate').val();
        var loadId = $('#receive-txt-loadId').val();
        var receiveId = $('#receive-txt-receiveId').val();

        warehouseId = warehouseId ? warehouseId : -1;
        loadId = loadId ? loadId : 0;
        checkOutDate = checkOutDate ? checkOutDate : getNowFormatDate();
        receiveId = receiveId ? receiveId : 0;
        $('#receive-dg').datagrid({
            url: '/settle/getReceiveHeader',
            pagePosition: 'bottom',
            rownumbers: true,
            singleSelect: true,
            queryParams: {
                warehouseId: warehouseId,
                loadId: loadId,
                checkOutDate: checkOutDate,
                receiveId: receiveId
            },
            onSelect: function (index, row) {
                getreceiveDetail(row);
            }

        });
    }
    function getreceiveDetail(row) {
        var warehouseId = row.warehouseId;
        var checkOutDate = $('#receive-date-deliverDate').val();
        var loadId = row.LoadId;
        var receiveId = row.ReceiveId;
        receiveId = receiveId ? receiveId : 0;

        $('#receive-detail-dg').datagrid({
            url: '/settle/getReceiveDetail',
            pagePosition: 'bottom',
            rownumbers: true,
            singleSelect: true,
            queryParams: {
                warehouseId: warehouseId,
                loadId: loadId,
                checkOutDate: checkOutDate,
                receiveId: receiveId
            }
        });
    }

    function receiveDetailMod() {
        var headerRow = $('#receive-dg').datagrid('getSelected')
        if (!headerRow) {
            $.messager.alert('消息提示:', "<center>请选择一条装运单</center>");
            return;
        }
        var loadId = headerRow.LoadId;
        var realDeliveryManId = $('#receive-detail-cg-staffId').val();;
        var monneyType = $('#receive-detail-cg-moneyType').val();
        var amount = $('#receive-detail-txt-amount').val();
        if (!realDeliveryManId) {
            $.messager.alert('消息提示:', "<center>请选择实际送货人</center>");
            return;
        }
        if (!monneyType) {
            $.messager.alert('消息提示:', "<center>请选择收款类型</center>");
            return;
        }
        if (!amount) {
            $.messager.alert('消息提示:', "<center>请输入收款金额</center>");
            return;
        }
        $.post("/settle/modifyReceive", { loadId: loadId, realDeliveryManId: realDeliveryManId, monneyType: monneyType, amount: amount },
            function (data) {
                $.messager.alert('消息提示:', "<center>" + data[0]["pramCode"] + "-" + data[0]["pramResult"] + "</center>");
                $('#receive-detail-dg').datagrid('reload');
            }
        );
    }

//usage
//wait for 3 seconds

</script>