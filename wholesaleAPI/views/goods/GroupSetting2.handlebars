{{!-- 数据格 --}}

<div class="easyui-layout" style="width:100%;height:100%;">
    <div data-options="region:'north',split:true" title="添加产品组" style="width:300px;height:200px;">
        <table id="group-dg" style="width:100%;height:250px;border-top:0px;" toolbar="#group-tbr" data-options="singleSelect:true,collapsible:true,method:'get',fit:true,border:false,">
            <thead>
                <tr>
                    <th data-options="field:'GoodsGroupId',width:150">商品组编号</th>
                    <th data-options="field:'Description',width:150">商品组名称</th>
                    <th data-options="field:'CreateUser',width:150">创建用户</th>
                    <th data-options="field:'UpdateUser',width:150">更新用户</th>
                    <th data-options="field:'CreateDate',width:150">创建时间</th>
                    <th data-options="field:'UpdateDate',width:150">更新时间</th>
                </tr>
            </thead>
        </table>
    </div>
    <div data-options="region:'center',split:true" title="选择产品" style="height:300px;">
        <table id="group-goods-dg" style="width:100%;height:250px;border-top:0px;" toolbar="#group-goods-tbr" data-options="singleSelect:true,collapsible:true,method:'get',fit:true,border:false,">
            <thead>
                <tr>
                    <th data-options="field:'CategoryId',width:150">商品类别编号</th>
                    <th data-options="field:'CategoryDescript',width:150">商品类别</th>
                    <th data-options="field:'BrandId',width:150">品牌编号</th>
                    <th data-options="field:'brandName',width:200">品牌名称</th>
                    <th data-options="field:'GoodsId',width:200">商品编号</th>
                    <th data-options="field:'Name',width:300">商品名称</th>
                    <th data-options="field:'BarCode',width:150">商品条码</th>
                    <th data-options="field:'Subunit',width:60">包装散数</th>
                    <th data-options="field:'Weight',width:60">重量</th>
                    <th data-options="field:'Length',width:60">长</th>
                    <th data-options="field:'Width',width:60">宽</th>
                    <th data-options="field:'Height',width:60">高</th>
                    <th data-options="field:'Volume',width:60">体积</th>
                    <th data-options="field:'Description',width:500">描述</th>
                    <th data-options="field:'ImageId',width:500">图片</th>
                    <th data-options="field:'UsefullLife',width:60">有效期</th>
                    <th data-options="field:'MiniLife',width:60">最小有效期</th>
                    <th data-options="field:'UpdateUser',width:60">更新用户</th>
                    <th data-options="field:'CreateDate',width:150">创建时间</th>
                    <th data-options="field:'UpdateDate',width:150">更新时间</th>
                </tr>
            </thead>
        </table>
    </div>
    <div data-options="region:'south',split:true" title="添加产品" style="height:250px;">
        <table id="group-detail-dg" style="width:100%;height:250px;border-top:0px;" toolbar="#group-detail-tbr" data-options="singleSelect:true,collapsible:true,method:'get',fit:true,border:false,">
            <thead>
                <tr>
                    <th data-options="field:'GoodsId',width:150">商品编号</th>
                    <th data-options="field:'Name',width:200">商品名称</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
{{!-- 工具栏 --}}
<div id="group-tbr">
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'" onclick="openDialogGroupAdd()">添加</a>
    <span class="datagrid-btn-separator" style="vertical-align: middle;display:inline-block;float:none"></span>
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-edit'" onclick="openDialogGroupEdit()">修改</a>
</div>

<div id="group-detail-tbr">
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'" onclick="GroupDetailAdd()">添加</a>
    <span class="datagrid-btn-separator" style="vertical-align: middle;display:inline-block;float:none"></span>
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-edit'" onclick="GroupDetailDel()">删除</a>
</div>

<div id="group-goods-tbr">
    <input id="group-goods-cbt-catagoryId" class="easyui-combotree" data-options="url:'/goods/getcatetree',method:'post',label:'选择分类:',labelPosition:'left'"
        style="width:250px">
    <select id="group-goods-cbg-brandId" class="easyui-combogrid" style="width:250px">
    </select>
    <input id="group-goods-txt-goodsId" style="width:90px;height:25px">
    <input id="group-goods-txt-name" style="width:120px;height:25px">
    <input id="group-goods-txt-barCode" style="width:120px;height:25px">
    <select id="group-goods-cbb-status" class="easyui-combobox" panelHeight="auto" style="width:100px">
        <option value="-1">选择状态</option>
        <option value="1">1-有效</option>
        <option value="0">0-无效</option>
    </select>
    <a id="group-goods-btn-search" onclick="groupGoodsSearch();" href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-search">查询</a>
</div>
{{!-- 对话框 --}}
<div id="group-dlg" class="easyui-dialog" title="添加商品" style="width:750px;height:500px;padding:10px" data-options="
                closed: true,
                iconCls: 'icon-add',
                buttons: [{
                    text:'提交',
                    iconCls:'icon-ok',
                    handler:function(){
                        $('#goods-ff-add').submit();
                        
                    }
                },{
                    text:'取消',
                    iconCls:'icon-cancel',
                    handler:function(){
                        $('#goods-dlg-add').dialog('close');
                    }
                }]
            ">
    <form id="group-ff" enctype="multipart/form-data" method="post">
        <table>
            <tr>
                <td>
                    <input id="group-txt-name" name="name" style="width:300px" class="f1 easyui-textbox" data-options="label:'商品组名称:',prompt:'输入商品组名称',required:true,validateOnCreate:false,err:err"></input>
                </td>
            </tr>
            <tr>
                <td>
                    <select id="group-cbb-edit-status" data-options="label:'状态:'" style="width:300px" name="status" class="easyui-combobox" panelHeight="auto"
                        style="width:100px">
                        <option value="1">1-有效</option>
                        <option value="0">0-无效</option>
                    </select>
                </td>
            </tr>

        </table>
        <input id="group-txt-groupId" type="hidden" name="groupId" value="">
    </form>
</div>

{{!-- 脚本 --}}
<script>


    $('#group-goods-dg').datagrid({
        url: '/goods/getgoods',
        queryParams: {
            barCode: -11
        },
        pagePosition: 'bottom',
        rownumbers: true,
        singleSelect: true

    });

    $('#group-dg').datagrid({
        url: '/goods/getgroup',
        pagePosition: 'bottom',
        rownumbers: true,
        singleSelect: true

    });

    $('#group-detail-dg').datagrid({
        url: '/goods/getgroupdetail',
        pagePosition: 'bottom',
        rownumbers: true,
        singleSelect: true

    });

    $.extend($.fn.textbox.methods, {
        addClearBtn: function (jq, iconCls) {
            return jq.each(function () {
                var t = $(this);
                var opts = t.textbox('options');
                opts.icons = opts.icons || [];
                opts.icons.unshift({
                    iconCls: iconCls,
                    handler: function (e) {
                        $(e.data.target).textbox('clear').textbox('textbox').focus();
                        $(this).css('visibility', 'hidden');
                    }
                });
                t.textbox();
                if (!t.textbox('getText')) {
                    t.textbox('getIcon', 0).css('visibility', 'hidden');
                }
                t.textbox('textbox').bind('keyup', function () {
                    var icon = t.textbox('getIcon', 0);
                    if ($(this).val()) {
                        icon.css('visibility', 'visible');
                    } else {
                        icon.css('visibility', 'hidden');
                    }
                });
            });
        }
    });


    $(function () {

        //-----

        $('#group-goods-txt-goodsId').textbox({
            prompt: '商品编号',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');

        $('#group-goods-txt-name').textbox({
            prompt: '商品名称',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');

        $('#group-goods-txt-barCode').textbox({
            prompt: '商品条码',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');

        $('#group-goods-txt-categoryId').textbox({
            prompt: '分类编号',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');

        $('#group-goods-txt-brandId').textbox({
            prompt: '品牌编号',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');
        //------

        $('#group-goods-ff-add').form({
            onSubmit: function () {
                $('#goods-ff-description').val($('#goods-te').texteditor('getValue'));

                if ($(this).form('enableValidation').form('validate')) {
                    MaskUtil.mask();
                    return true;
                } else {
                    return false;
                }
            },
            success: function (data) {
                MaskUtil.unmask();
                data = JSON.parse(data);
                $.messager.alert('消息提示:', "<center>" + data[0]["pramResult"] + "</center>");
                if (data[0]['pramCode'] == "1") {
                    $('#goods-ff-add').form('clear');
                    goodsClear();
                    $('#goods-dlg-add').dialog('close');
                    goodsSearch();
                }
            },
        });
    });

    function groupGoodsSearch() {
        var categoryRow = $('#group-goods-cbt-catagoryId').combotree('tree').tree('getSelected');
        var brandRow = $('#group-goods-cbg-brandId').combogrid('grid').datagrid('getSelected');
        $('#group-goods-dg').datagrid('load', {
            goodsId: $('#group-goods-txt-goodsId').textbox('getValue'),
            name: $('#group-goods-txt-name').textbox('getValue'),
            barCode: $('#group-goods-txt-barCode').textbox('getValue'),
            categoryId: categoryRow ? categoryRow.id : -1,
            brandId: brandRow ? brandRow.BrandId : -1,
            status: $('#group-goods-cbb-status').combobox('getValue')
        });
    }

    function openDialogGroupAdd() {
        $('#group-ff').form({
            url: '/goods/addgroup',
        });
        $('#group-dlg').dialog({
            modal: true,
            title: '添加产品组'
        }).dialog('open');
    }
    function openDialogGroupEdit() {
        var row = $('#group-dg').datagrid('getSelected');
        $('#group-txt-groupId').val(row.GoodsGroupId);
        $('#group-ff').form({
            url: '/goods/editgroup',
        });
        $('#group-dlg').dialog({
            modal: true,
            title: '修改产品组'
        }).dialog('open');
    }
    function groupBrandSearch(q, searchList, ele) {
        ele.combogrid('grid').datagrid('loadData', []);
        if (q == "") {
            ele.combogrid('grid').datagrid('loadData', groupBrandData);
            return;
        }
        var rows = [];

        $.each(groupBrandData, function (i, obj) {
            for (var p in searchList) {
                var v = obj[searchList[p]];
                console.log('v='+ele.combogrid('getText'));
                if (!!v && v.toString().indexOf(q) >= 0) {
                    //alert('vviii='+v.toString());
                    rows.push(obj);
                    break;
                }
            }
        });
        if (rows.length == 0) {
            ele.combogrid('grid').datagrid('loadData', []);
            return;
        }
        ele.combogrid('grid').datagrid('loadData', rows);
    }
    var groupBrandData;
    $.ajax({
        url: "/goods/getbrand?status=1",
        type: "get",
        dataType: "json",
        success: function (result) {
            groupBrandData = result;
            $("#group-goods-cbg-brandId").combogrid({
                panelWidth: 400,
                idField: 'BrandId',
                textField: 'Name',
                method: 'get',
                data: groupBrandData,
                mode:'local',
                columns: [[
                    { field: 'BrandId', title: '品牌编号', width: 80 },
                    { field: 'Name', title: '品牌名称', width: 120 },
                    { field: 'Company', title: '公司名称', width: 80 }
                ]],
                fitColumns: true,
                label: '选择品牌:',
                labelPosition: 'left',
                filter: function (q,row) {
                        if(row['Name'].indexOf(q) >-1)
                        {
                            //var rows[];
                            console.log('name='+row['Name'])
                            return true;
                            //rows.push(row);
                        }
                    groupBrandSearch(q, ['Name'],$(this));
                },
                //onShowPanel: function () {
                //  $(this).combogrid('grid').datagrid('loadData', groupBrandData);
                // }
            });
        }
    });



</script>