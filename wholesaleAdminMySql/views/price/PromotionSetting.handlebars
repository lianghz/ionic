{{!-- 数据格 --}}
<table id="promotion-dg" class="easyui-datagrid" title="品牌管理" style="width:100%;height:250px;border-top:0px;" toolbar="#promotion-tbr"
    data-options="singleSelect:true,collapsible:true,method:'get',fit:true,border:false,">
    <thead>
        <tr>
            <th data-options="field:'AdjustId',width:100">因子编号</th>
            <th data-options="field:'Description',width:200">描述</th>
            <th data-options="field:'WarehouseId',width:100">仓库编号</th>
            <th data-options="field:'WarehouseName',width:150">仓库名称</th>
            <th data-options="field:'PriceListId',width:60">价表</th>
            <th data-options="field:'AdjustMethodId',width:60">调整方法</th>
            <th data-options="field:'MethodName',width:150">方法名</th>
            <th data-options="field:'EffectGoodsGroupId',width:100">生效产品组</th>
            <th data-options="field:'EffectGroupName',width:150">组描述</th>
            <th data-options="field:'EffectQuantity',width:50">生效数量</th>
            <th data-options="field:'AdjustRate',width:50">调整比率</th>
            <th data-options="field:'GiveGoodsGroupId',width:100">赠送商品组</th>
            <th data-options="field:'GiveGroupName',width:150">组描述</th>
            <th data-options="field:'BeginDate',width:100">生效起</th>
            <th data-options="field:'EndDate',width:100">生效止</th>
            <th data-options="field:'EffectTotalAmount',width:50">生效金额</th>
            <th data-options="field:'MinLevelId',width:50">生效等级</th>
            <th data-options="field:'SpecialPriceStatus',width:50">是否特价促销</th>
            <th data-options="field:'Status',width:60">状态</th>
            <th data-options="field:'UpdateUser',width:100">更新人</th>
            <th data-options="field:'UpdateDate',width:100">更新时间</th>
        </tr>
    </thead>
</table>
{{!-- 工具栏 --}}
<div id="promotion-tbr">
    仓库:
    <select id="promotion-cbg-warehouseId" class="easyui-combogrid" style="width:180px" data-options="
                    panelWidth: 200,
                    idField: 'ItemValue',
                    textField: 'ItemText',
                    url: '/common/warehouse',
                    method: 'get',
                    columns: [[
                        {field:'ItemValue',title:'编号',width:100},
                        {field:'ItemText',title:'名称',width:120}
                    ]],
                    onChange: function (q){  
                        Search();
                        //return false;  
                    },  
                    fitColumns: true
                ">
    </select>
    <input id="promotion-txt-adjustId" style="width:120px;height:25px">
    <input id="promotion-txt-adjustName" style="width:120px;height:25px"> 开始时间:
    <input id="promotion-date-startDate" class="easyui-datebox" style="width:100px;"> 结束时间:
    <input id="promotion-date-endDate" class="easyui-datebox" style="width:100px;">
    <select id="promotion-cbb-status" class="easyui-combobox" panelHeight="auto" style="width:100px">
        <option value="-1">选择状态</option>
        <option value="1">1-有效</option>
        <option value="0">0-无效</option>
    </select>
    <a id="promotion-btn-search" href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-search">查询</a>
    <span class="datagrid-btn-separator" style="vertical-align: middle;display:inline-block;float:none"></span>
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'" onclick="promotionOpenDialogAdd()">添加</a>
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-edit'" onclick="promotionOpenDialogEdit()">修改</a>

</div>
{{!-- 数据上下文 --}}
<input id="promotion-params" type="hidden" name="referrer" value="{{params}}">
<input id="promotion-params2" type="hidden" name="referrer" value="{{params2}}"> {{!-- 表单 --}}
<div id="promotion-dlg" class="easyui-dialog" title="添加因子" style="width:750px;height:490px;padding:10px" data-options="
                closed: true,
                iconCls: 'icon-add',
                buttons: [{
                    text:'提交',
                    iconCls:'icon-ok',
                    handler:function(){
                        $('#promotion-ff').submit();
                        
                    }
                },{
                    text:'取消',
                    iconCls:'icon-cancel',
                    handler:function(){
                        $('#promotion-dlg').dialog('close');
                    }
                }]
            ">
    <form id="promotion-ff" action="/price/addpromotion" method="post">
        <table>
            <tr>
                <td>
                    <input id="promotion-ff-txt-adjustid" name="adjustId" style="width:300px" class="f1 easyui-textbox" data-options="label:'因子编号:',prompt:'输入因子编号',required:true,validateOnCreate:false,err:err"></input>
                </td>
                <td>
                    <input id="promotion-ff-txt-name" name="name" style="width:300px " class="f1 easyui-textbox " data-options="label:
                        '因子说明:',prompt: '输入因子说明',required:true,validateOnCreate:false,err:err "></input>
                </td>
            </tr>
            <tr>
                <td>
                    <input id="promotion-ff-cg-warehouseId" name="warehouseId" style="width:300px" class="easyui-combogrid" data-options="label: '仓库:',prompt: '输入仓库',required:true,validateOnCreate:false,err:err,panelWidth: 400,
                    idField: 'ItemValue',
                    textField: 'ItemText',
                    url: '/common/warehouse',
                    method: 'get',
                    columns: [[
                        {field:'ItemValue',title:'编号',width:100},
                        {field:'ItemText',title:'名称',width:120}
                    ]],
                    onChange: function (q){  
                        Search();
                        //return false;  
                    },  
                    fitColumns: true
                "></input>
                </td>
                <td>
                    <input id="promotion-ff-date-startDate" name="beginDate" class="easyui-datebox" style="width:200pt;" data-options="label:'开始时间:',prompt: '输入开始时间',required:true,validateOnCreate:false,err:err">
                </td>
            </tr>
            <tr>
                <td>
                    <input id="promotion-ff-date-endDate" name="endDate" class="easyui-datebox" style="width:200pt;" data-options="label: '结束时间:',prompt: '输入结束时间',required:true,validateOnCreate:false,err:err">
                </td>
                <td>
                    <input id="promotion-ff-txt-priceListId" name="priceListId" style="width:300px" class="f1 easyui-textbox" data-options="label:'价表编号:',prompt:'价表编号',required:true,validateOnCreate:false,err:err"></input>
                </td>
            </tr>
            <tr>
                <td>
                    <input id="promotion-ff-txt-adjustMethodId" name="adjustMethodId" style="width:300px" class="easyui-combogrid" data-options="label:'调整方法:',prompt:'输入调整方法',required:true,validateOnCreate:false,err:err
                    ,idField: 'ItemValue',
                    textField: 'ItemText',
                    url: '/common/getAdjust',
                    method: 'get',
                    columns: [[
                        {field:'ItemValue',title:'编号',width:100},
                        {field:'ItemText',title:'名称',width:120}
                    ]],
                    onChange: function (q){  
                        Search();
                        //return false;  
                    },  
                    fitColumns: true
                "></input>
                </td>
                <td>
                    <input id="promotion-ff-txt-effectGoodsGroupId" name="effectGoodsGroupId" style="width:300px" class="easyui-combogrid" data-options="label:'影响商品组:',prompt:'影响商品组',required:true,validateOnCreate:false,err:err
                    ,idField: 'GoodsGroupId',
                    textField: 'Description',
                    url: '/goods/getgroup',
                    method: 'get',
                    columns: [[
                        {field:'GoodsGroupId',title:'编号',width:100},
                        {field:'Description',title:'名称',width:120}
                    ]],
                    onChange: function (q){  
                        Search();
                        //return false;  
                    },  
                    fitColumns: true
                "></input>
                </td>
            </tr>
            <tr>
                <td>
                    <input id="promotion-ff-txt-effectQuantity" name="effectQuantity" style="width:300px" class="f1 easyui-textbox" data-options="label:'生效数量:',prompt:'输入生效数量',required:true,validateOnCreate:false,err:err"></input>
                </td>
                <td>
                    <input id="promotion-ff-txt-adjustRate" name="adjustRate" style="width:300px" class="f1 easyui-textbox" data-options="label:'调整幅度:',prompt:'调整幅度',required:true,validateOnCreate:false,err:err"></input>
                </td>
            </tr>
            <tr>
                <td>
                    <input id="promotion-ff-txt-giveGoodsGroupId" name="giveGoodsGroupId" style="width:300px" class="easyui-combogrid" data-options="label:'赠送商品组:',prompt:'输入赠送商品组',required:true,validateOnCreate:false,err:err
                     ,idField: 'GoodsGroupId',
                    textField: 'Description',
                    url: '/goods/getgroup',
                    method: 'get',
                    columns: [[
                        {field:'GoodsGroupId',title:'编号',width:100},
                        {field:'Description',title:'名称',width:120}
                    ]],
                    onChange: function (q){  
                        Search();
                        //return false;  
                    },  
                    fitColumns: true
                "></input>
                </td>
                <td>
                    <input id="promotion-ff-txt-effectTotalAmount" name="effectTotalAmount" style="width:300px" class="f1 easyui-textbox" data-options="label:'促销生效金额:',prompt:'促销生效金额',required:true,validateOnCreate:false,err:err"></input>
                </td>
            </tr>
            <tr>
                <td>
                    <input id="promotion-ff-txt-minLevelId" name="minLevelId" style="width:300px" class="f1 easyui-textbox" data-options="label:'最小享受促销等级:',prompt:'输入最小享受促销等级',required:true,validateOnCreate:false,err:err"></input>
                </td>
                <td>
                    <select id="promotion-ff-cb-specialPriceStatus" name="specialPriceStatus" class="easyui-combobox" panelHeight="auto" data-options="label:'特价促销:',width:200,prompt:'选择特价促销',required:true,validateOnCreate:false,err:err">
                        <option value="0">0-否</option>
                        <option value="1">1-是</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    <select id="promotion-ff-cb-status" name="status" class="easyui-combobox" panelHeight="auto" style="width:200pt" data-options="label:'状态:',prompt:'输入重量',required:true,validateOnCreate:false,err:err">
                        <option value="-1">选择状态</option>
                        <option value="1">1-有效</option>
                        <option value="0">0-无效</option>
                    </select>
                </td>
                <td>
                    <input id="promotion-ff-txt-type" name="type" style="width:300px" type="hidden" />
                </td>
            </tr>
        </table>
    </form>
</div>

{{!-- 脚本 --}}
<script>

    $.extend($.fn.textbox.methods, {
        addClearBtn: function (jq, iconCls) {
            return jq.each(function () {
                var t = $(this);
                var opts = t.textbox('options');
                opts.icons = opts.icons || [];
                opts.icons.unshift({
                    iconCls: iconCls,
                    handler: function (e) {
                        $(e.data.target).textbox('clear').textbox('textbox').focus();
                        $(this).css('visibility', 'hidden');
                    }
                });
                t.textbox();
                if (!t.textbox('getText')) {
                    t.textbox('getIcon', 0).css('visibility', 'hidden');
                }
                t.textbox('textbox').bind('keyup', function () {
                    var icon = t.textbox('getIcon', 0);
                    if ($(this).val()) {
                        icon.css('visibility', 'visible');
                    } else {
                        icon.css('visibility', 'hidden');
                    }
                });
            });
        }
    });


    $(function () {

        //-----

        $('#promotion-txt-adjustId').textbox({
            prompt: '因子编号',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');

        $('#promotion-txt-adjustName').textbox({
            prompt: '因子名称',
            icons: [{
                iconCls: 'icon-filter'
            }]
        }).textbox('addClearBtn', 'icon-clear');

        //------

        $('#promotion-ff').form({
            onSubmit: function () {
                if ($(this).form('enableValidation').form('validate')) {
                    $('#promotion-dlg').dialog('close');
                    MaskUtil.mask();
                    return true;
                } else {
                    return false;
                }
            },
            success: function (data) {
                MaskUtil.unmask();
                data = JSON.parse(data);
                $.messager.alert('消息提示:', "<center>" + data[0]["pramResult"] + "</center>");
                $('#promotion-dg').datagrid('reload');
            },

        });

        //search
        $("#promotion-btn-search").click(function () {
            var warehouseRow = $('#promotion-cbg-warehouseId').combogrid('grid').datagrid('getSelected');
            $('#promotion-dg').datagrid({
                url: '/price/getpromotion',
                pagePosition: 'bottom',
                rownumbers: true,
                singleSelect: true,
                queryParams: {
                    adjustId: $('#promotion-txt-adjustId').textbox('getValue'),
                    name: $('#promotion-txt-adjustName').textbox('getValue'),
                    warehouseId: warehouseRow.ItemValue,
                    startDate: $('#promotion-date-startDate').datebox('getValue'),
                    endDate: $('#promotion-date-endDate').datebox('getValue'),
                    status: $('#promotion-cbb-status').combobox('getValue')
                }
            });
        })
        //end search
    });

    function promotionOpenDialogAdd() {
        $('#promotion-ff-txt-type').val("1");
        $('#promotion-dlg').dialog({
            title: "添加因子",
            modal: true,
        }).dialog('open');
    }

    function promotionOpenDialogEdit() {


        $('#promotion-ff-txt-type').val("2");
        var row = $('#promotion-dg').datagrid('getSelected');
        if (!row) {
            $.messager.alert('提示', '<center>请选择一个促销!</center>');
        }
        $('#promotion-ff').form('load', {
            adjustId: row.AdjustId,
            name: row.Description,
            warehouseId: row.WarehouseId,
            priceListId: row.PriceListId,
            adjustMethodId: row.AdjustMethodId,
            effectGoodsGroupId: row.EffectGoodsGroupId,
            effectQuantity: row.EffectQuantity,
            adjustRate: row.AdjustRate,
            giveGoodsGroupId: row.GiveGoodsGroupId,
            beginDate: row.BeginDate,
            endDate: row.EndDate,
            effectTotalAmount: row.EffectTotalAmount,
            minLevelId: row.MinLevelId,
            specialPriceStatus: row.SpecialPriceStatus,
            status: row.Status
        });

        $('#promotion-dlg').dialog({
            title: "修改因子",
            modal: true,
        }).dialog('open');
    }
    function Search() {

    }


</script>